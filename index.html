<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Traffic Flow Analysis Dashboard</title>

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel (compiles JSX in the browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Recharts (UMD bundle) -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  </head>

  <body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useMemo, useState } = React;

      const {
        ResponsiveContainer,
        LineChart,
        Line,
        XAxis,
        YAxis,
        CartesianGrid,
        Tooltip,
        Legend
      } = Recharts;

      // ---------------------------
      // Traffic Flow Models
      // ---------------------------
      function greenshieldsSpeed(k, uf, kj) {
        return uf * (1 - k / kj);
      }
      function greenshieldsFlow(k, uf, kj) {
        return k * greenshieldsSpeed(k, uf, kj);
      }

      function greenbergSpeed(k, uf, kj) {
        if (k <= 0) return NaN;
        return uf * Math.log(kj / k);
      }
      function greenbergFlow(k, uf, kj) {
        const u = greenbergSpeed(k, uf, kj);
        return k * u;
      }

      function underwoodSpeed(k, uf, ko) {
        return uf * Math.exp(-k / ko);
      }
      function underwoodFlow(k, uf, ko) {
        const u = underwoodSpeed(k, uf, ko);
        return k * u;
      }

      function getLOS(flow, capacity) {
        if (!capacity || capacity <= 0) return { level: "-", desc: "N/A" };
        const vByC = flow / capacity;

        if (vByC <= 0.35) return { level: "A", desc: "Free Flow", badge: "bg-green-600" };
        if (vByC <= 0.54) return { level: "B", desc: "Reasonably Free Flow", badge: "bg-green-500" };
        if (vByC <= 0.77) return { level: "C", desc: "Stable Flow", badge: "bg-yellow-500" };
        if (vByC <= 0.93) return { level: "D", desc: "Approaching Unstable", badge: "bg-orange-500" };
        if (vByC <= 1.0)  return { level: "E", desc: "Unstable Flow", badge: "bg-red-500" };
        return { level: "F", desc: "Forced Flow", badge: "bg-red-700" };
      }

      function TrafficAnalysisDashboard() {
        const [selectedModel, setSelectedModel] = useState("greenshields");

        // Sliders (you can change these defaults)
        const [freeFlowSpeed, setFreeFlowSpeed] = useState(65);  // mph
        const [jamDensity, setJamDensity] = useState(180);       // veh/mi

        // Underwood needs ko. We'll use ko = kj/2 by default.
        const ko = useMemo(() => jamDensity / 2, [jamDensity]);

        const modelMeta = useMemo(() => ({
          greenshields: {
            name: "Greenshields Model",
            speed: (k) => greenshieldsSpeed(k, freeFlowSpeed, jamDensity),
            flow:  (k) => greenshieldsFlow(k, freeFlowSpeed, jamDensity),
            xLabel: "Density (veh/mi)",
          },
          greenberg: {
            name: "Greenberg Model",
            speed: (k) => greenbergSpeed(k, freeFlowSpeed, jamDensity),
            flow:  (k) => greenbergFlow(k, freeFlowSpeed, jamDensity),
            xLabel: "Density (veh/mi)",
          },
          underwood: {
            name: "Underwood Model",
            speed: (k) => underwoodSpeed(k, freeFlowSpeed, ko),
            flow:  (k) => underwoodFlow(k, freeFlowSpeed, ko),
            xLabel: "Density (veh/mi)",
          }
        }), [freeFlowSpeed, jamDensity, ko]);

        const activeModel = modelMeta[selectedModel];

        // Generate curve data
        const trafficData = useMemo(() => {
          const data = [];
          const steps = 120;
          const kMin = selectedModel === "greenberg" ? 1 : 0; // avoid ln(0)
          const kMax = jamDensity;
          const step = (kMax - kMin) / steps;

          for (let i = 0; i <= steps; i++) {
            const k = kMin + i * step;
            const u = activeModel.speed(k);
            const q = activeModel.flow(k);

            if (Number.isFinite(u) && Number.isFinite(q) && u >= 0 && q >= 0) {
              data.push({
                density: Math.round(k * 10) / 10,
                speed: Math.round(u * 10) / 10,
                flow: Math.round(q),
              });
            }
          }
          return data;
        }, [activeModel, selectedModel, jamDensity]);

        // Capacity (max flow point)
        const capacityAnalysis = useMemo(() => {
          if (!trafficData.length) return null;
          let maxFlow = -Infinity;
          let capPoint = trafficData[0];

          for (const p of trafficData) {
            if (p.flow > maxFlow) {
              maxFlow = p.flow;
              capPoint = p;
            }
          }

          return {
            capacity: Math.round(maxFlow),
            criticalDensity: capPoint.density,
            criticalSpeed: capPoint.speed,
          };
        }, [trafficData]);

        // Sample flows to show LOS
        const sampleFlows = [1200, 1800, 2400, 3000];

        return (
          <div className="min-h-screen">
            <header className="bg-white border-b">
              <div className="max-w-6xl mx-auto px-4 py-6">
                <h1 className="text-3xl font-bold text-gray-900">Traffic Flow Analysis Dashboard</h1>
                <p className="text-gray-600 mt-1">Interactive Transportation Engineering Analysis Tool</p>
              </div>
            </header>

            <main className="max-w-6xl mx-auto px-4 py-6 space-y-6">
              {/* Controls */}
              <div className="bg-white rounded-2xl shadow p-5">
                <div className="grid md:grid-cols-3 gap-6">
                  <div>
                    <label className="text-sm font-semibold text-gray-700">
                      Free-Flow Speed (mph): <span className="font-bold">{freeFlowSpeed}</span>
                    </label>
                    <input
                      type="range"
                      min="45"
                      max="75"
                      value={freeFlowSpeed}
                      onChange={(e) => setFreeFlowSpeed(Number(e.target.value))}
                      className="w-full mt-2"
                    />
                  </div>

                  <div>
                    <label className="text-sm font-semibold text-gray-700">
                      Jam Density (veh/mi): <span className="font-bold">{jamDensity}</span>
                    </label>
                    <input
                      type="range"
                      min="100"
                      max="250"
                      value={jamDensity}
                      onChange={(e) => setJamDensity(Number(e.target.value))}
                      className="w-full mt-2"
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      (Underwood uses k₀ = k<sub>j</sub>/2 → {Math.round(ko)} veh/mi)
                    </p>
                  </div>

                  <div>
                    <label className="text-sm font-semibold text-gray-700">Traffic Flow Model</label>
                    <select
                      value={selectedModel}
                      onChange={(e) => setSelectedModel(e.target.value)}
                      className="w-full mt-2 border rounded-lg p-2"
                    >
                      <option value="greenshields">Greenshields</option>
                      <option value="greenberg">Greenberg</option>
                      <option value="underwood">Underwood</option>
                    </select>
                    <p className="text-xs text-gray-500 mt-1">{activeModel.name}</p>
                  </div>
                </div>
              </div>

              {/* Metrics */}
              <div className="grid md:grid-cols-3 gap-4">
                <div className="bg-white rounded-2xl shadow p-5">
                  <p className="text-sm text-gray-500">Road Capacity</p>
                  <p className="text-3xl font-bold">
                    {capacityAnalysis ? capacityAnalysis.capacity.toLocaleString() : "—"}
                  </p>
                  <p className="text-sm text-gray-600">veh/hr</p>
                </div>

                <div className="bg-white rounded-2xl shadow p-5">
                  <p className="text-sm text-gray-500">Critical Density</p>
                  <p className="text-3xl font-bold">
                    {capacityAnalysis ? capacityAnalysis.criticalDensity : "—"}
                  </p>
                  <p className="text-sm text-gray-600">veh/mi</p>
                </div>

                <div className="bg-white rounded-2xl shadow p-5">
                  <p className="text-sm text-gray-500">Critical Speed</p>
                  <p className="text-3xl font-bold">
                    {capacityAnalysis ? capacityAnalysis.criticalSpeed : "—"}
                  </p>
                  <p className="text-sm text-gray-600">mph</p>
                </div>
              </div>

              {/* Charts */}
              <div className="grid lg:grid-cols-2 gap-6">
                <div className="bg-white rounded-2xl shadow p-5">
                  <h2 className="text-lg font-bold mb-3">Speed–Density</h2>
                  <div className="h-72">
                    <ResponsiveContainer width="100%" height="100%">
                      <LineChart data={trafficData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="density" label={{ value: "Density (veh/mi)", position: "insideBottom", offset: -5 }} />
                        <YAxis label={{ value: "Speed (mph)", angle: -90, position: "insideLeft" }} />
                        <Tooltip />
                        <Legend />
                        <Line type="monotone" dataKey="speed" name="Speed (mph)" dot={false} />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                </div>

                <div className="bg-white rounded-2xl shadow p-5">
                  <h2 className="text-lg font-bold mb-3">Flow–Density</h2>
                  <div className="h-72">
                    <ResponsiveContainer width="100%" height="100%">
                      <LineChart data={trafficData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="density" label={{ value: "Density (veh/mi)", position: "insideBottom", offset: -5 }} />
                        <YAxis label={{ value: "Flow (veh/hr)", angle: -90, position: "insideLeft" }} />
                        <Tooltip />
                        <Legend />
                        <Line type="monotone" dataKey="flow" name="Flow (veh/hr)" dot={false} />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                </div>
              </div>

              <div className="bg-white rounded-2xl shadow p-5">
                <h2 className="text-lg font-bold mb-3">Speed–Flow</h2>
                <div className="h-80">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={trafficData}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="flow" label={{ value: "Flow (veh/hr)", position: "insideBottom", offset: -5 }} />
                      <YAxis label={{ value: "Speed (mph)", angle: -90, position: "insideLeft" }} />
                      <Tooltip />
                      <Legend />
                      <Line type="monotone" dataKey="speed" name="Speed (mph)" dot={false} />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </div>

              {/* LOS Table */}
              <div className="bg-white rounded-2xl shadow p-5">
                <h2 className="text-lg font-bold mb-4">Level of Service (LOS) — Sample Volumes</h2>

                {!capacityAnalysis ? (
                  <p className="text-gray-600">No capacity computed.</p>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="min-w-full text-sm">
                      <thead>
                        <tr className="text-left border-b">
                          <th className="py-2 pr-4">Volume (veh/hr)</th>
                          <th className="py-2 pr-4">v/c</th>
                          <th className="py-2 pr-4">LOS</th>
                          <th className="py-2 pr-4">Description</th>
                        </tr>
                      </thead>
                      <tbody>
                        {sampleFlows.map((v) => {
                          const ratio = v / capacityAnalysis.capacity;
                          const los = getLOS(v, capacityAnalysis.capacity);
                          return (
                            <tr key={v} className="border-b">
                              <td className="py-2 pr-4">{v.toLocaleString()}</td>
                              <td className="py-2 pr-4">{ratio.toFixed(2)}</td>
                              <td className="py-2 pr-4">
                                <span className={`text-white px-2 py-1 rounded-md ${los.badge || "bg-gray-400"}`}>
                                  {los.level}
                                </span>
                              </td>
                              <td className="py-2 pr-4">{los.desc}</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>

              <footer className="text-center text-xs text-gray-500 pb-6">
                Built by Ashish Basnet • M.S. Transportation Engineering
              </footer>
            </main>
          </div>
        );
      }

      // Mount app
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<TrafficAnalysisDashboard />);
    </script>
  </body>
</html>
